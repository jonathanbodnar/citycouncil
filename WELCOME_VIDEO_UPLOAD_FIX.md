# Welcome Video Upload Fix

## Issue
Welcome video upload is failing with CSP errors and possibly storage bucket issues.

## Fixes Required

### 1. Run SQL Migration
This creates the `welcome_video_url` setting in the database:

```bash
# Connect to your Supabase SQL Editor and run:
database/add_welcome_video_url_setting.sql
```

### 2. Create Storage Bucket in Supabase

**Go to Supabase Dashboard → Storage:**

1. Click **"New bucket"**
2. Name: `platform-assets`
3. **Public bucket**: Yes ✅ (important!)
4. Click **"Create bucket"**

**Set CORS Policy:**
1. Click on the `platform-assets` bucket
2. Go to **Configuration** → **CORS**
3. Add this CORS policy:

```json
[
  {
    "allowedOrigins": ["*"],
    "allowedMethods": ["GET", "POST", "PUT", "DELETE"],
    "allowedHeaders": ["*"],
    "exposedHeaders": [],
    "maxAgeSeconds": 3600
  }
]
```

### 3. Set File Size Limits

In Supabase Dashboard → Storage → `platform-assets` bucket:

1. Go to **Policies**
2. Click **"New Policy"**
3. For **INSERT**:
   - Policy name: `Allow authenticated uploads to platform-assets`
   - Target roles: `authenticated`
   - Policy definition:
   ```sql
   bucket_id = 'platform-assets'
   ```

4. For **SELECT** (read):
   - Policy name: `Public read access to platform-assets`
   - Target roles: `anon`, `authenticated`
   - Policy definition:
   ```sql
   bucket_id = 'platform-assets'
   ```

### 4. Verify Upload Size Limits

In Supabase Dashboard → Project Settings → Storage:
- Make sure **max file size** is at least **750MB** (or 786432000 bytes)

## Testing

1. Go to Admin Dashboard → Platform Settings
2. Scroll to "Welcome Page Video"
3. Click "Choose File" and select a video
4. Click "Upload Video"
5. Wait for upload (may take a few minutes for large files)
6. Should see success toast and video preview

## Common Issues

### Issue: "Bucket not found"
**Fix:** Create the `platform-assets` bucket (see step 2)

### Issue: Upload fails silently
**Fix:** Check browser console for CSP errors. The CSP policy in `server.js` should already allow Supabase storage.

### Issue: "File too large"
**Fix:** Increase the max file size in Supabase Storage settings to 750MB+

### Issue: Upload takes forever
**Note:** A 465MB video can take 5-10 minutes to upload depending on internet speed. The upload button will show a spinner - don't refresh the page!

## What Gets Stored

- **Database**: `platform_settings` table, key: `welcome_video_url`
- **Storage**: `platform-assets/videos/welcome-video-{timestamp}.{ext}`
- **Public URL**: Auto-generated by Supabase Storage

## Manual URL Update (Workaround)

If upload keeps failing, you can manually set the URL:

```sql
-- Upload video to Supabase Storage manually, then:
UPDATE platform_settings
SET 
  setting_value = 'YOUR_VIDEO_PUBLIC_URL_HERE',
  updated_at = NOW()
WHERE setting_key = 'welcome_video_url';
```

